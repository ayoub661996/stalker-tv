<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stalker TV Final</title>
    <style>
        body { font-family: -apple-system, system-ui; background: #000; color: #fff; padding: 15px; text-align: center; }
        .card { background: #1c1c1e; padding: 20px; border-radius: 15px; border: 1px solid #333; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #2c2c2e; color: #fff; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #34c759; color: #000; border: none; border-radius: 8px; font-weight: bold; }
        .channel { background: #1c1c1e; padding: 15px; margin-top: 10px; border-radius: 10px; display: flex; justify-content: space-between; border: 1px solid #333; cursor: pointer; }
        #debug { font-size: 11px; color: #888; margin-top: 10px; white-space: pre-wrap; text-align: left; direction: ltr; }
    </style>
</head>
<body>
    <div class="card">
        <h3>Stalker Player Pro</h3>
        <input id="url" type="text" placeholder="رابط البورتال" value="http://mag.greatott.me">
        <input id="mac" type="text" placeholder="الماك أدريس" value="00:1A:79:C2:D4:B4">
        <button id="btn" onclick="run()">تشغيل القنوات</button>
        <div id="debug"></div>
    </div>
    <div id="list"></div>

    <script>
        const proxy = "https://api.allorigins.win/raw?url=";

        async function run() {
            const debug = document.getElementById('debug');
            const portal = document.getElementById('url').value.trim();
            const mac = document.getElementById('mac').value.trim();
            const api = `${portal}/server/load.php`;
            
            debug.innerText = "جاري المحاولة...";
            
            try {
                // 1. Handshake
                const hUrl = `${api}?type=stb&action=handshake`;
                const hRes = await fetch(proxy + encodeURIComponent(hUrl));
                const hText = await hRes.text();
                const hData = JSON.parse(hText);
                const token = hData.js.token;

                debug.innerText += "\nتم الاتصال.. جاري جلب القنوات";

                // 2. Get All Channels
                const cUrl = `${api}?type=itv&action=get_all_channels`;
                const cRes = await fetch(proxy + encodeURIComponent(cUrl), {
                    headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
                });
                const cText = await cRes.text();
                const cData = JSON.parse(cText);
                
                const list = document.getElementById('list');
                list.innerHTML = "";
                
                // التأكد من وجود بيانات
                const channels = cData.js.data || cData.js;
                
                channels.forEach(ch => {
                    let div = document.createElement('div');
                    div.className = 'channel';
                    div.innerHTML = `<span>${ch.name}</span> <span>▶</span>`;
                    div.onclick = async () => {
                        const lUrl = `${api}?type=itv&action=create_link&cmd=${encodeURIComponent(ch.cmd)}`;
                        const lRes = await fetch(proxy + encodeURIComponent(lUrl), {
                            headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
                        });
                        const lData = await lRes.json();
                        let stream = lData.js.cmd.split(" ")[0].replace("ffrt", "").trim();
                        // تشغيل مباشر في VLC
                        window.location.href = `vlc://` + stream;
                    };
                    list.appendChild(div);
                });
                debug.innerText = "تم تحميل " + channels.length + " قناة!";
            } catch (e) {
                debug.innerText += "\nخطأ: " + e.message;
                console.error(e);
            }
        }
    </script>
</body>
</html>
