<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stalker TV Pro</title>
    <style>
        body { font-family: -apple-system, system-ui; background: #000; color: #fff; padding: 15px; }
        input { width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; border: 1px solid #333; background: #1c1c1e; color: #fff; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #34c759; color: #fff; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; }
        .search-box { position: sticky; top: 0; background: #000; padding: 10px 0; z-index: 100; }
        .channel { background: #1c1c1e; padding: 15px; margin-top: 8px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #34c759; }
    </style>
</head>
<body>
    <div id="login-screen">
        <h3>إعدادات السيرفر</h3>
        <input id="url" type="text" placeholder="رابط البورتال (مثل http://pureiptv.in/c)">
        <input id="mac" type="text" placeholder="الماك أدريس (00:1A:79:...)">
        <button onclick="connect()">تسجيل الدخول</button>
    </div>

    <div id="main-screen" style="display:none;">
        <div class="search-box">
            <input id="search" type="text" placeholder="بحث عن قناة..." oninput="filterChannels()">
        </div>
        <div id="list"></div>
    </div>

    <script>
        const proxy = "https://api.allorigins.win/raw?url="; // وسيط لفك حظر CORS
        let allChannels = [];

        async function connect() {
            const portal = document.getElementById('url').value.trim().replace(/\/$/, "");
            const mac = document.getElementById('mac').value.trim();
            const api = `${portal}/server/load.php`;
            
            try {
                // المرحلة 1: Handshake
                let res = await fetch(`${proxy}${encodeURIComponent(api + '?type=stb&action=handshake')}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest', 'Cookie': `mac=${mac}` }
                });
                let d = await res.json();
                const token = d.js.token;

                // المرحلة 2: جلب القنوات
                let chs = await fetch(`${proxy}${encodeURIComponent(api + '?type=itv&action=get_all_channels')}`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
                });
                let chData = await chs.json();
                allChannels = chData.js.data;
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-screen').style.display = 'block';
                display(allChannels, api, token, mac);
            } catch(e) { alert("فشل الاتصال: تأكد من الماك أدريس أو جرب شبكة أخرى"); }
        }

        function display(data, api, token, mac) {
            const list = document.getElementById('list');
            list.innerHTML = "";
            data.forEach(c => {
                let div = document.createElement('div');
                div.className = 'channel';
                div.innerHTML = `<span>${c.name}</span> <small style="color:#888">▶</small>`;
                div.onclick = async () => {
                    let linkRes = await fetch(`${proxy}${encodeURIComponent(api + '?type=itv&action=create_link&cmd=' + c.cmd)}`, {
                        headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
                    });
                    let linkData = await linkRes.json();
                    let final = linkData.js.cmd.split(" ")[0].replace("ffrt", "").trim();
                    window.location.href = `vlc-x-callback://x-callback-url/stream?url=${encodeURIComponent(final)}`;
                };
                list.appendChild(div);
            });
        }

        function filterChannels() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = allChannels.filter(c => c.name.toLowerCase().includes(term));
            display(filtered); // ملاحظة: ستحتاج لتمرير البيانات الأخرى أيضاً للبحث الكامل
        }
    </script>
</body>
</html>
