<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stalker TV Ultra</title>
    <style>
        body { font-family: -apple-system, system-ui; background: #0b0b0b; color: #fff; padding: 20px; text-align: center; }
        .box { background: #1c1c1e; padding: 20px; border-radius: 15px; border: 1px solid #333; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #2c2c2e; color: #fff; font-size: 14px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #ff9500; color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .channel { background: #1c1c1e; padding: 15px; margin-top: 10px; border-radius: 10px; display: flex; justify-content: space-between; border: 1px solid #333; }
        #log { font-size: 12px; color: #8e8e93; margin-top: 10px; text-align: left; direction: ltr; }
    </style>
</head>
<body>
    <div class="box">
        <h3>Stalker Player</h3>
        <input id="url" type="text" placeholder="رابط البورتال" value="http://mag.greatott.me">
        <input id="mac" type="text" placeholder="الماك أدريس" value="00:1A:79:C2:D4:B4">
        <button onclick="start()">تشغيل الآن</button>
        <div id="log"></div>
    </div>
    <div id="list"></div>

    <script>
        // البروكسي البديل (Cors-proxy)
        const proxy = "https://corsproxy.io/?";

        async function start() {
            const log = document.getElementById('log');
            const portal = document.getElementById('url').value.trim().replace(/\/$/, "");
            const mac = document.getElementById('mac').value.trim();
            const api = `${portal}/server/load.php`;

            log.innerText = "جاري الاتصال بالسيرفر...";
            
            try {
                // 1. Handshake
                const handshake = `${api}?type=stb&action=handshake`;
                const hRes = await fetch(proxy + encodeURIComponent(handshake));
                const hData = await hRes.json();
                const token = hData.js.token;
                log.innerText += "\nتم الحصول على الرمز (Token)";

                // 2. Get Channels
                const chReq = `${api}?type=itv&action=get_all_channels`;
                const cRes = await fetch(proxy + encodeURIComponent(chReq), {
                    headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
                });
                const cData = await cRes.json();
                
                const list = document.getElementById('list');
                list.innerHTML = "";
                
                cData.js.data.forEach(ch => {
                    let div = document.createElement('div');
                    div.className = 'channel';
                    div.innerHTML = `<span>${ch.name}</span> <span>▶</span>`;
                    div.onclick = async () => {
                        const linkReq = `${api}?type=itv&action=create_link&cmd=${ch.cmd}`;
                        const lRes = await fetch(proxy + encodeURIComponent(linkReq), {
                            headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
                        });
                        const lData = await lRes.json();
                        let streamUrl = lData.js.cmd.split(" ")[0].replace("ffrt", "").trim();
                        window.location.href = `vlc://` + streamUrl; // اختصار مباشر لـ VLC
                    };
                    list.appendChild(div);
                });
                log.innerText = "تم تحميل " + cData.js.data.length + " قناة بنجاح!";
            } catch (e) {
                log.innerText += "\nخطأ: " + e.message;
                alert("تأكد أن السيرفر يعمل وأن الماك أدريس صحيح.");
            }
        }
    </script>
</body>
</html>
