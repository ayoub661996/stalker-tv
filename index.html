<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stalker Pro Mobile</title>
    <style>
        body { font-family: -apple-system, system-ui; background: #000; color: #fff; padding: 20px; text-align: center; }
        .container { max-width: 500px; margin: auto; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; background: #1c1c1e; color: #fff; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; background: #007aff; color: #fff; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .channel { background: #1c1c1e; padding: 15px; margin-top: 10px; border-radius: 12px; cursor: pointer; border: 1px solid #2c2c2e; text-align: right; display: flex; justify-content: space-between; }
        #status { color: #ff3b30; font-size: 14px; margin: 10px 0; }
        .loader { color: #8e8e93; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Stalker TV Pro</h3>
        <input id="url" type="text" placeholder="رابط البورتال (Portal URL)" value="http://mag.greatott.me/">
        <input id="mac" type="text" placeholder="الماك أدريس (MAC Address)" value="00:1A:79:C2:D4:B4">
        <button id="loginBtn" onclick="connect()">تسجيل الدخول</button>
        <div id="status"></div>
        <div id="list"></div>
    </div>

    <script>
        // هذا الوسيط يحل مشكلة CORS للآيفون
        const proxy = "https://api.allorigins.win/raw?url=";

        async function connect() {
            const portal = document.getElementById('url').value.trim().replace(/\/$/, "");
            const mac = document.getElementById('mac').value.trim();
            const status = document.getElementById('status');
            const list = document.getElementById('list');
            const api = `${portal}/server/load.php`;
            
            status.innerText = "جاري كسر الحماية والاتصال...";
            status.className = "loader";

            try {
                // خطوة 1: Handshake عبر البروكسي
                let handshakeUrl = `${api}?type=stb&action=handshake`;
                let res = await fetch(proxy + encodeURIComponent(handshakeUrl), {
                    headers: { 'Cookie': `mac=${mac}` }
                });
                let d = await res.json();
                const token = d.js.token;

                // خطوة 2: جلب القنوات
                status.innerText = "جاري تحميل القائمة...";
                let chUrl = `${api}?type=itv&action=get_all_channels`;
                let chs = await fetch(proxy + encodeURIComponent(chUrl), {
                    headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
                });
                let chData = await chs.json();
                
                list.innerHTML = "";
                chData.js.data.forEach(c => {
                    let div = document.createElement('div');
                    div.className = 'channel';
                    div.innerHTML = `<span>${c.name}</span> <small>▶</small>`;
                    div.onclick = async () => {
                        let linkUrl = `${api}?type=itv&action=create_link&cmd=${c.cmd}`;
                        let linkRes = await fetch(proxy + encodeURIComponent(linkUrl), {
                            headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
                        });
                        let linkData = await linkRes.json();
                        let final = linkData.js.cmd.split(" ")[0].replace("ffrt", "").trim();
                        // فتح في VLC
                        window.location.href = `vlc-x-callback://x-callback-url/stream?url=${encodeURIComponent(final)}`;
                    };
                    list.appendChild(div);
                });
                status.innerText = `تم العثور على ${chData.js.data.length} قناة`;
                status.style.color = "#34c759";
            } catch(e) { 
                status.innerText = "فشل الاتصال. تأكد من صحة البيانات أو جرب شبكة أخرى.";
                status.style.color = "#ff3b30";
            }
        }
    </script>
</body>
</html>
