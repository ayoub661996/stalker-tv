<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stalker Player</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #000; color: #fff; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: auto; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #1c1c1e; color: #fff; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #007aff; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .channel-card { background: #1c1c1e; padding: 15px; margin-top: 10px; border-radius: 12px; display: flex; align-items: center; cursor: pointer; border: 1px solid #2c2c2e; }
        .channel-name { font-size: 14px; font-weight: 500; }
        #status { color: #8e8e93; font-size: 12px; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Stalker STB Mobile</h3>
        <input id="url" type="text" placeholder="رابط البورتال (http://...:8080)">
        <input id="mac" type="text" placeholder="الماك أدريس (00:1A:79:...)">
        <button onclick="connect()">تسجيل الدخول</button>
        <div id="status"></div>
        <div id="channels"></div>
    </div>

    <script>
        async function connect() {
            const portal = document.getElementById('url').value.replace(/\/$/, "");
            const mac = document.getElementById('mac').value;
            const status = document.getElementById('status');
            const api = `${portal}/server/load.php`;
            
            status.innerText = "جاري الاتصال...";
            try {
                let res = await fetch(`${api}?type=stb&action=handshake`, { headers: { 'Cookie': `mac=${mac}` } });
                let data = await res.json();
                const token = data.js.token;

                status.innerText = "جاري جلب القنوات...";
                let chRes = await fetch(`${api}?type=itv&action=get_all_channels`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
                });
                let chData = await chRes.json();
                displayChannels(chData.js.data, api, token, mac);
                status.innerText = `تم العثور على ${chData.js.data.length} قناة`;
            } catch (e) { status.innerText = "خطأ: تأكد من البيانات أو تفعيل CORS بالسيرفر"; }
        }

        function displayChannels(channels, api, token, mac) {
            const container = document.getElementById('channels');
            container.innerHTML = "";
            channels.forEach(ch => {
                let div = document.createElement('div');
                div.className = "channel-card";
                div.innerHTML = `<span class="channel-name">${ch.name}</span>`;
                div.onclick = () => play(ch.cmd, api, token, mac);
                container.appendChild(div);
            });
        }

        async function play(cmd, api, token, mac) {
            let res = await fetch(`${api}?type=itv&action=create_link&cmd=${cmd}`, {
                headers: { 'Authorization': `Bearer ${token}`, 'Cookie': `mac=${mac}` }
            });
            let data = await res.json();
            let finalUrl = data.js.cmd.replace(/ffrt /g, "").split(" ")[0];
            // رابط فتح VLC على iOS
            window.location.href = `vlc-x-callback://x-callback-url/stream?url=${encodeURIComponent(finalUrl)}`;
        }
    </script>
</body>
</html>
